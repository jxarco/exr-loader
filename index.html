<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />

<title>exr loader</title>
<link rel="stylesheet" href="css/bootstrap.min.css">
	<style type='text/css'>
		html, body { width: 100%; height: 100%; margin: 0; padding: 0 }
    select, option { color: black; }
	</style>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
	<script type="text/javascript" src="js/gl-matrix-min.js"></script>
	<script type="text/javascript" src="js/litegl-mod.js"></script>
    <script type="text/javascript" src="js/dat.gui.min.js"></script>
	<script type="text/javascript" src="js/tinyexr.js"></script>
	<script type="text/javascript" src="js/rendeer.js"></script>
    <script type="text/javascript" src="js/EXRLoader.js"></script>
	<script type="text/javascript">

        function init()
        {
            //create a scene
            scene = new RD.Scene();

            //create the rendering context
            var context = GL.create({width: window.innerWidth, height: window.innerHeight});

            renderer = new RD.Renderer(context, {
                shaders_file: "data/shaders.glsl",
                autoload_assets: true
            });

            document.body.appendChild(renderer.canvas); //attach

            document.body.ondragover = function(){ return false;}
            document.body.ondragend = function(){ return false;}
            document.body.ondrop = function( e )
            {
                e.preventDefault();
                document.querySelector("#loading").style.display = "block";

                var file = e.dataTransfer.files[0],
                    name = file.name;

                //prepare reader
                var reader = new FileReader();
                reader.onload = function (event) {
                    var data = event.target.result;
                    load( data, true );
                };

                //read data
                reader.readAsArrayBuffer(file);
                return false;
            }

            //create camera
            camera = new RD.Camera();
            camera.perspective( 45, gl.canvas.width / gl.canvas.height, 0.01, 1000000 );
           	camera.lookAt( [0,0,750],[0,0,0],[0,1,0] );

            skybox = new RD.SceneNode({
                mesh: "cube"
            });

            skybox.flags.depth_test = false;
            skybox.flags.flip_normals = true;
            skybox.flags.visible = false;
            skybox.render_priority = RD.PRIORITY_BACKGROUND;
            scene.root.addChild( skybox );

            //create a cube in the scene
            plane = new RD.SceneNode();
            plane.position = [0,0,0];
            plane.color = [1,1,1,1];
            plane.mesh = "plane";
            plane.scale([100,100,100]);
            plane.flags.two_sided = true;
            plane.flags.visible = false;
            scene.root.addChild(plane);

            renderer._uniforms.exposure = 5.0;
            renderer._uniforms.brightMax = 18.0;

            var params_gui = {
                'Exposure': renderer._uniforms.exposure,
                'Texture mode': EXRLoader.EM_ONLY,
                'Convert SM': EXRLoader.TO_CUBEMAP,
                'Gen. CM size': EXRLoader.CUBE_MAP_SIZE,

                'Cube map': function(){ readFile("cubemap.exr") },
                'Sphere map': function(){ readFile("water.exr") },
                'CM conversion': function(){ readFile("water.exr", true) }
            };

            var gui = new dat.GUI();
            var f1 = gui.addFolder("Examples");
            f1.add( params_gui, 'Cube map');
            f1.add( params_gui, 'Sphere map');
            f1.add( params_gui, 'CM conversion');
            var f2 = gui.addFolder("Options");
            f2.add( params_gui, 'Exposure', 0.1, 20 );
            f2.add( params_gui, 'Texture mode', { "Show only": false, "Use EM": true } );
            // gui.add( params_gui, 'Convert SM' );
            f2.add( params_gui, 'Gen. CM size', [64, 128, 256, 512, 1024] );

            f1.open();
            f2.open();

            //global settings
            var bg_color = vec4.fromValues(0.2,0.3,0.4,1);

            //main render loop
            var last = now = getTime();

            function ondraw() {

                // get gui params_gui
                renderer._uniforms.exposure = params_gui['Exposure'];
                EXRLoader.CUBE_MAP_SIZE = params_gui['Gen. CM size'];
                EXRLoader.TO_CUBEMAP = params_gui['Convert SM'];
                EXRLoader.EM_ONLY = JSON.parse( params_gui['Texture mode'] );

                last = now;
                now = getTime();
                var dt = (now - last) * 0.001;
                renderer.clear(bg_color);

                skybox.position = camera.position;
                renderer.render(scene, camera);
            }

            renderer.context.ondraw = ondraw;
            renderer.context.onupdate = function(dt){
                scene.update(dt);
            }
            renderer.context.animate();

            //input
            renderer.context.captureMouse(true);
            renderer.context.onmousemove = function(e)
            {
                if(e.dragging){
                    camera.orbit(-e.deltax * 0.01, RD.UP);
                    camera.orbit(-e.deltay * 0.01, camera._right);
                }
            }
            renderer.context.onmousewheel = function(e)
            {
                if(!e.wheel)
                    return;
                camera.position = vec3.scale( camera.position, camera.position, e.wheel < 0 ? 1.05 : 0.95 );
            }
        }

        function load( buffer, to_cubemap )
        {
            loader = new EXRLoader();

            var texData = loader.parse(buffer),
                texParams = loader.getTextureParams(texData),
                texture = loader.generateTex(texParams);

            if(!EXRLoader.EM_ONLY)
            {
                // basic/flat textures
                console.log("'Show only' mode")
                renderer.textures["exr"] = texture;
                plane.texture = "exr";
                plane.shader = "exposure";
                skybox.flags.visible = false;
                plane.flags.visible = true;
                plane.scaling = [texture.width, -texture.height, 1];
                camera.lookAt( [0,0,texture.width * 1.25],[0,0,0],[0,1,0] );
                document.querySelector("#loading").style.display = "none";
                return;
            }

            console.log("'EM' mode")

            // no cubemap
            if(!texParams.is_cubemap)
            {
                // in case of having to convert the texture
                if(EXRLoader.TO_CUBEMAP && to_cubemap)
                {
                    loader.toCubemap(texture);
                    document.querySelector("#loading").style.display = "none";
                    return;
                }
                // from spheremap images directly
                skybox.shader = "sphereMap";
            }
            else // from cubemap images
                skybox.shader = "skyboxExpo";

            renderer.textures["exr"] = texture;
            skybox.texture = "exr";
            plane.flags.visible = false;
            skybox.flags.visible = true;
            camera.lookAt( [5,5,5],[0,5,0],[0,1,0] );
            document.querySelector("#loading").style.display = "none";
        }

	</script>
</head>
<body>
	<p id="loading" style="margin: 20px; position: absolute; color: white; margin-top: 5px; font-size: 22px; display: none;">Loading...</p>
</body>

    <script>
        // init app here
		init();
        //

        // $("#toggle").change(function(){
        //     EXRLoader.EM_ONLY = !this.checked;
        // });
	</script>
</html>
